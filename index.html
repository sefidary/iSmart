<!DOCTYPE HTML>
<html>
<head>
<title>smartHome</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1"> 
    <link rel="stylesheet"  href="css/jquery.mobile-1.3.1.min.css">
    <link rel="stylesheet"  href="css/SmartHome.min.css">
	<script src="js/jquery.js"></script>
	<script src="js/jquery.mobile-1.3.1.min.js"></script>
	<script src="phonegap.js"></script>
<script type="text/javascript" charset="utf-8">

    // Wait for device API libraries to load
    //
    document.addEventListener("deviceready", onDeviceReady, false);

 
    function onDeviceReady() {
		$.ajaxSetup({timeout:800});
        //window.localStorage.setItem("key", "sefidali");
        var checkFirst = window.localStorage.getItem("firstTime");
		if( checkFirst === null ){
		$.mobile.changePage( "#myDialog", { role: "dialog" } );
		//window.localStorage.setItem("firstTime", "1");
		}else {
		var server = window.localStorage.getItem("server");
		$("#serveraddress").val(server);
		var port =window.localStorage.getItem("port");
		$("#portaddress").val(port);
		var html =window.localStorage.getItem("html");
		$('#dokme').html(html).trigger( "create" );
		$('.sliderswitch').change(function() 
		{ 
			var switchid= $(this).attr('data-switch');
			var curentval=$(this).val();
			var server = window.localStorage.getItem("server");
			var port =window.localStorage.getItem("port");
			var url="http://"+server+":"+port+"/?fn=03&nod="+switchid+"&dat="+curentval;
			$.get(url , function(data) {});
		});
		}
		
	
		
    }
	$(document).ready(function(){
		$.ajaxSetup({timeout:800});
		$('.sliderswitch').change(function() 
		{ console.log(switchid);
			var switchid= $(this).attr('data-switch');
			$.get("http://"+server+":"+port+"/?fn=03&nod="+switchid+"&dat="+$('#slider2').val() , function(data) {
 
		});
			
		});
		
	});
	function processNode(arr) {
		arr=arr.split("][");
		var length = arr.length,
			element = null;
		var html="";
		var perclick="";
		for (var i = 0; i < length; i++) {
		  arr[i] = arr[i].replace(/[\][<html>/]/g, "");
		 	 perclick=  arr[i].split(",");
			 var stringName = perclick[0] ;
			 var nodeType=stringName.substr(0,2);
			if(nodeType=="01") { var  nodeName = "پریز"; } else if(nodeType=="02") {  var  nodeName = "تک پل";} 
			if(nodeType=="03") { //do pol 
			var  nodeName = "دو پل";
			 if(perclick[1]=="XX") {
		  	 html = html+'<label  for="slider'+perclick[0]+'">پل اول '+nodeName+' '+perclick[0]+':</label> <select disabled name="slider'+perclick[0]+'1" id="slider'+perclick[0]+'1" class="sliderswitch" data-switch="'+perclick[0]+'1" data-role="slider"> <option value="00">قطع</option>    </select> <br>';
			 }else if(perclick[1]=="1") {
			html = html+'<label for="slider'+perclick[0]+'">پل اول '+nodeName+' '+perclick[0]+':</label> <select  name="slider'+perclick[0]+'1" id="slider'+perclick[0]+'1" class="sliderswitch"  data-switch="'+perclick[0]+'1" data-role="slider"> <option value="00">خاموش</option>    <option selected value="01">روشن</option></select> <br>'; 
			 }else if(perclick[1]=="0")  {
				 html = html+'<label for="slider'+perclick[0]+'">پل اول '+nodeName+' '+perclick[0]+':</label> <select  name="slider'+perclick[0]+'1" id="slider'+perclick[0]+'1" class="sliderswitch"  data-switch="'+perclick[0]+'1" data-role="slider"> <option selected value="00">خاموش</option>    <option  value="01">روشن</option></select> <br>'; 
			 }
			 if(perclick[2]=="XX") {
		  	 html = html+'<label  for="slider'+perclick[0]+'">پل دوم '+nodeName+' '+perclick[0]+':</label> <select disabled name="slider'+perclick[0]+'2" id="slider'+perclick[0]+'2" class="sliderswitch" data-switch="'+perclick[0]+'2" data-role="slider"> <option value="00">قطع</option>    </select> <br>';
			 }else if(perclick[2]=="1") {
			html = html+'<label for="slider'+perclick[0]+'">پل دوم '+nodeName+' '+perclick[0]+':</label> <select  name="slider'+perclick[0]+'2" id="slider'+perclick[0]+'2" class="sliderswitch"  data-switch="'+perclick[0]+'2" data-role="slider"> <option value="00">خاموش</option>    <option selected value="01">روشن</option></select> <br>'; 
			 }else if(perclick[2]=="0")  {
				 html = html+'<label for="slider'+perclick[0]+'">پل دوم '+nodeName+' '+perclick[0]+':</label> <select  name="slider'+perclick[0]+'2" id="slider'+perclick[0]+'2" class="sliderswitch"  data-switch="'+perclick[0]+'2" data-role="slider"> <option selected value="00">خاموش</option>    <option  value="01">روشن</option></select> <br>'; 
			 }
			 
			} else { //tak pol vaaa priiz
				if(perclick[1]=="XX") {
				 html = html+'<label  for="slider'+perclick[0]+'"> '+nodeName+' '+perclick[0]+':</label> <select disabled name="slider'+perclick[0]+'" id="slider'+perclick[0]+'" class="sliderswitch" data-switch="'+perclick[0]+'" data-role="slider"> <option value="00">قطع</option>    </select> <br>';
				 }else if(perclick[1]=="1") {
				html = html+'<label for="slider'+perclick[0]+'"> '+nodeName+' '+perclick[0]+':</label> <select  name="slider'+perclick[0]+'" id="slider'+perclick[0]+'" class="sliderswitch"  data-switch="'+perclick[0]+'" data-role="slider"> <option value="00">خاموش</option>    <option selected value="01">روشن</option></select> <br>'; 
				 }else if(perclick[1]=="0")  {
					 html = html+'<label for="slider'+perclick[0]+'"> '+nodeName+' '+perclick[0]+':</label> <select  name="slider'+perclick[0]+'" id="slider'+perclick[0]+'" class="sliderswitch"  data-switch="'+perclick[0]+'" data-role="slider"> <option selected value="00">خاموش</option>    <option  value="01">روشن</option></select> <br>'; 
				 }
				
			}
		}
		$('#dokme').html(html).trigger( "create" );
		
		window.localStorage.setItem("html", html);
		
		$('.sliderswitch').change(function() 
		{ 
			var switchid= $(this).attr('data-switch');
			var nodeType=switchid.substr(0,2);
			var server = window.localStorage.getItem("server");
			var port =window.localStorage.getItem("port");
			if (nodeType=="03") {
				var nodeCurent = switchid.substr(-1,1);
				if(nodeCurent =='1' ) {
					var avalival=$(this).val();
					var switchIDR= switchid.substr(0,4);
					var oniekiID=switchIDR+'2';
					var dovomival=$('#slider'+oniekiID).val();
					
				}else {
					var dovomival=$(this).val();
					var switchIDR= switchid.substr(0,4);
					var oniekiID=switchIDR+'1';
					var avalival=$('#slider'+oniekiID).val();
					
				}
				var url="http://"+server+":"+port+"/?fn=03&nod="+switchIDR+"&dat="+avalival+dovomival;
				$.get(url , function(data) {});
			} else {
				var curentval=$(this).val();
				var server = window.localStorage.getItem("server");
				var port =window.localStorage.getItem("port");
				var url="http://"+server+":"+port+"/?fn=03&nod="+switchid+"&dat="+curentval;
				$.get(url , function(data) {});
			}
			});
	}
	function checkdata() {
		var server = window.localStorage.getItem("server");
		$("#serveraddress").val(server);
		var port =window.localStorage.getItem("port");
		$("#portaddress").val(port);
	$.get("http://"+server+":"+port+"/?fn=02" , function(data) {
		processNode(data);
		
	});
	}
	function submitdata() {
			window.localStorage.setItem("firstTime", "1");
			var server = $("#serveraddress").val();
			var port = $("#portaddress").val();
			window.localStorage.setItem("server", server);
			window.localStorage.setItem("port", port);
			checkdata();
			window.history.back();
}
	
    </script>
</head>
<body> 

<div data-role="page" id="mainpage">

<div data-role="header" data-position="fixed">
	<h1>خانه هوشمند </h1>
</div>

	<div data-role="content">	
		<a href="#myDialog" data-rel="dialog" data-role="button">تغییر تنظیمات</a>
        <a href="#" data-role="button" onClick="checkdata()" >دریافت اطلاعات 2</a>
		<form id="dokme" >
        
        </form>
	</div><!-- /content -->
	
</div><!-- /page -->


<div data-role="page" id="myDialog">

<div data-role="header" data-position="fixed">
	<h1>تنظیمات </h1>
</div>

	<div data-role="content">	
		<label for="serveraddress">آدرس سرور:</label>
<input type="text" name="serveraddress" id="serveraddress" value="">
<label for="portaddress">پورت</label>
<input type="text" name="portaddress" id="portaddress" value="">
<button  id="savebotton" onClick="submitdata();">ذخیره</button>

	</div><!-- /content -->
</div>
</body>
</html>